
/* Success response sample 
{
  "success": true,
  "errorCode": null,
  "dataName": "sessionData",
  "data": {
    "sessionChanged": false,
    "vehicleInactivated": false,
    "account": {
      "createdDate": 1634513804000,
      "marketId": 1,
      "firstName": "Liam",
      "lastName": "Harry",
      "zipCode": "19064",
      "accountKey": 153577,
      "lastLoginDate": 1657288876000,
      "zipCode5": "19064"
    },
    "resetPassword": false,
    "deviceId": "2762148",
    "sessionId": "D98180E9E24B3412215CA8BBD0C87DD6",
    "deviceRegistered": false,
    "passwordToken": "$2a$10$lG75plnGPD8mEOYb3NVK7.qOQlYAgpKVrwA4cOe/KLdoQVndZ1obq",
    "vehicles": [
      {
        "customer": {
          "sessionCustomer": null,
          "email": null,
          "firstName": null,
          "lastName": null,
          "zip": null,
          "oemCustId": null,
          "phone": null
        },
        "features": null,
        "vin": "4S3BMAA66D1038385",
        "modelYear": null,
        "modelCode": null,
        "engineSize": null,
        "nickname": "2013 Legacy 2.5i",
        "vehicleKey": 119677,
        "active": true,
        "licensePlate": "",
        "licensePlateState": "",
        "email": null,
        "firstName": null,
        "lastName": null,
        "subscriptionFeatures": null,
        "accessLevel": -1,
        "zip": null,
        "oemCustId": "CRM-9-TBIJ3VFG",
        "vehicleMileage": null,
        "phone": null,
        "timeZone": "America/New_York",
        "stolenVehicle": false,
        "vehicleName": "2013 Legacy 2.5i",
        "userOemCustId": "CRM-9-TBIJ3VFG",
        "subscriptionStatus": null,
        "authorizedVehicle": false,
        "preferredDealer": null,
        "cachedStateCode": "NJ",
        "subscriptionPlans": [],
        "crmRightToRepair": false,
        "needMileagePrompt": false,
        "phev": null,
        "extDescrip": null,
        "intDescrip": null,
        "modelName": null,
        "transCode": null,
        "provisioned": true,
        "remoteServicePinExist": true,
        "needEmergencyContactPrompt": false,
        "vehicleGeoPosition": null,
        "show3gSunsetBanner": false,
        "sunsetUpgraded": true
      },
      {
        "customer": {
          "sessionCustomer": null,
          "email": null,
          "firstName": null,
          "lastName": null,
          "zip": null,
          "oemCustId": null,
          "phone": null
        },
        "features": null,
        "vin": "4S3GXAT65PA000144",
        "modelYear": null,
        "modelCode": null,
        "engineSize": null,
        "nickname": "impreza144 Gen3",
        "vehicleKey": 11835,
        "active": true,
        "licensePlate": "",
        "licensePlateState": "",
        "email": null,
        "firstName": null,
        "lastName": null,
        "subscriptionFeatures": null,
        "accessLevel": 2,
        "zip": null,
        "oemCustId": "CRM-75UEXK93-N",
        "vehicleMileage": null,
        "phone": null,
        "timeZone": null,
        "stolenVehicle": false,
        "vehicleName": "impreza144 Gen3",
        "userOemCustId": "CRM-476-ZGY18A",
        "subscriptionStatus": null,
        "authorizedVehicle": true,
        "preferredDealer": null,
        "cachedStateCode": "NJ",
        "subscriptionPlans": [],
        "crmRightToRepair": false,
        "needMileagePrompt": false,
        "phev": null,
        "extDescrip": null,
        "intDescrip": null,
        "modelName": null,
        "transCode": null,
        "provisioned": true,
        "remoteServicePinExist": true,
        "needEmergencyContactPrompt": false,
        "vehicleGeoPosition": null,
        "show3gSunsetBanner": false,
        "sunsetUpgraded": true
      },
      {
        "customer": {
          "sessionCustomer": null,
          "email": null,
          "firstName": null,
          "lastName": null,
          "zip": null,
          "oemCustId": null,
          "phone": null
        },
        "features": null,
        "vin": "4S3BMAA62D1013693",
        "modelYear": null,
        "modelCode": null,
        "engineSize": null,
        "nickname": "2022 Legacy 2.5i",
        "vehicleKey": 15295,
        "active": true,
        "licensePlate": "",
        "licensePlateState": "",
        "email": null,
        "firstName": null,
        "lastName": null,
        "subscriptionFeatures": null,
        "accessLevel": 1,
        "zip": null,
        "oemCustId": "CRM-8-ZJTM1PLL",
        "vehicleMileage": null,
        "phone": null,
        "timeZone": null,
        "stolenVehicle": false,
        "vehicleName": "2022 Legacy 2.5i",
        "userOemCustId": "CRM-078-DBN08C",
        "subscriptionStatus": null,
        "authorizedVehicle": true,
        "preferredDealer": null,
        "cachedStateCode": "NJ",
        "subscriptionPlans": [],
        "crmRightToRepair": false,
        "needMileagePrompt": false,
        "phev": null,
        "extDescrip": null,
        "intDescrip": null,
        "modelName": null,
        "transCode": null,
        "provisioned": true,
        "remoteServicePinExist": true,
        "needEmergencyContactPrompt": false,
        "vehicleGeoPosition": null,
        "show3gSunsetBanner": false,
        "sunsetUpgraded": true
      }
    ],
    "rightToRepairEnabled": true,
    "rightToRepairStartYear": 2022,
    "rightToRepairStates": "MA",
    "termsAndConditionsAccepted": true,
    "enableXtime": true,
    "digitalGlobeConnectId": "0572e32b-2fcf-4bc8-abe0-1e3da8767132",
    "digitalGlobeImageTileService": "https://earthwatch.digitalglobe.com/earthservice/tmsaccess/tms/1.0.0/DigitalGlobe:ImageryTileService@EPSG:3857@png/{z}/{x}/{y}.png?con",
    "digitalGlobeTransparentTileService": "https://earthwatch.digitalglobe.com/earthservice/tmsaccess/tms/1.0.0/Digitalglobe:OSMTransparentTMSTileService@EPSG:3857@png/{z}",
    "tomtomKey": "E3TldymJMX3RSyqusbUSAewPfkEXaebN",
    "currentVehicleIndex": 0,
    "handoffToken": "$2a$08$DAUYBx1RNoK.vPDHmKoGluM9I3VjnDGNhEbRMAsOB16EXGU5dLD5K$1657288950612",
    "satelliteViewEnabled": true,
    "registeredDevicePermanent": false
  }
}
*/

// Do all responses have this shape?
interface LoginResponse {
    success: "true" | "false"
    errorCode: string | null
    dataName: string | null
    data: null | SessionData
}

interface SessionData {
    sessionChanged: boolean,
    vehicleInactivated: boolean,
    account: object, // TODO
    resetPassword: boolean,
    // TODO: finish types
    deviceId: "2762148",
    sessionId: "D98180E9E24B3412215CA8BBD0C87DD6",
    deviceRegistered: false,
    passwordToken: "$2a$10$lG75plnGPD8mEOYb3NVK7.qOQlYAgpKVrwA4cOe/KLdoQVndZ1obq",
    vehicles: object[],
    rightToRepairEnabled: true,
    rightToRepairStartYear: 2022,
    rightToRepairStates: "MA",
    termsAndConditionsAccepted: true,
    enableXtime: true,
    digitalGlobeConnectId: "0572e32b-2fcf-4bc8-abe0-1e3da8767132",
    digitalGlobeImageTileService: "https://earthwatch.digitalglobe.com/earthservice/tmsaccess/tms/1.0.0/DigitalGlobe:ImageryTileService@EPSG:3857@png/{z}/{x}/{y}.png?con",
    digitalGlobeTransparentTileService: "https://earthwatch.digitalglobe.com/earthservice/tmsaccess/tms/1.0.0/Digitalglobe:OSMTransparentTMSTileService@EPSG:3857@png/{z}",
    tomtomKey: "E3TldymJMX3RSyqusbUSAewPfkEXaebN",
    currentVehicleIndex: 0,
    handoffToken: "$2a$08$DAUYBx1RNoK.vPDHmKoGluM9I3VjnDGNhEbRMAsOB16EXGU5dLD5K$1657288950612",
    satelliteViewEnabled: true,
    registeredDevicePermanent: false
}

export type NETEnvironmentID = "local8080" | "local8084" | "cloudqa" | "cloudprod" | "clouddr";

export interface NETEnvironment {
    env: NETEnvironmentID
    domain: string
}

const environments: {[key in NETEnvironmentID]: NETEnvironment} = {
    local8080: {env: "local8080", domain: "localhost:8080"},
    local8084: {env: "local8084", domain: "localhost:8084"},
    cloudqa: {env: "cloudqa", domain: "mobileapi.qa.subarucs.com"},
    cloudprod: {env: "cloudprod", domain: "mobileapi.prod.subarucs.com"},
    clouddr: {env: "clouddr", domain: "mobileapi.dr-prod.subarucs.com"},
}

let _env: NETEnvironmentID = "cloudqa"; 

export const net_setEnvironment = (name: NETEnvironmentID) => {
    _env = name;
}

export const net_getEnviroment = (name?: NETEnvironmentID): NETEnvironment => {
    return environments[name ?? _env];
}

export const net_login = async (environment?: NETEnvironment): Promise<LoginResponse> => {
    const e = environment ?? net_getEnviroment();
    const response = await fetch(`https://${e.domain}/g2v23/login.json`, {
        "headers": {
            "accept": "*/*",
            "accept-language": "en-US,en;q=0.9",
            "content-type": "application/x-www-form-urlencoded; charset=UTF-8",
            "sec-ch-ua": "\" Not A;Brand\";v=\"99\", \"Chromium\";v=\"96\", \"Microsoft Edge\";v=\"96\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"macOS\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site"
        },
        "referrer": "http://localhost:8000/",
        "referrerPolicy": "strict-origin-when-cross-origin",
        "body": `env=${e.env}&loginUsername=mysubaruwatch%40yahoo.com&password=Subaru123&deviceId=2762148&passwordToken=&selectedVin=4S3BMAA66D1038385&rememberUserCheck=on&pushToken=&deviceType=`,
        "method": "POST",
        "mode": "cors",
        "credentials": "omit"
    });
    const json = await response.json();
    /**
     * TODO: Parse and validate JSON matches spec, error otherwise
     *       On error, also check response codes (ex: clouddr is currently 501) 
     *       In all cases, construct a valid payload and return
     *       {success: "false", errorCode: *something*, dataName: "sessionData", data: null}
     */ 
    const parsed: LoginResponse = json;
    return parsed;
}